<center>

  ![](../chart.drawio.svg)

  **Ethereum2.0: スケーラビリティ向上**

</center>

学習目的や学習対象に対するフレーバーテキストをここに配置する
学習目的や学習対象に対するフレーバーテキストをここに配置する
学習目的や学習対象に対するフレーバーテキストをここに配置する
学習目的や学習対象に対するフレーバーテキストをここに配置する
学習目的や学習対象に対するフレーバーテキストをここに配置する
学習目的や学習対象に対するフレーバーテキストをここに配置する

- [Ethereum 2.0 とは何か？](#ethereum-20-とは何か)
  - [端的に言えばBitcoinの一般化である](#端的に言えばbitcoinの一般化である)
  - [この一般化を計算機科学の文脈でたとえると...](#この一般化を計算機科学の文脈でたとえると)
  - [この一般化によって様々なアプリケーション開発が可能となる](#この一般化によって様々なアプリケーション開発が可能となる)
  - [1.0 から 2.0 での主な変更点](#10-から-20-での主な変更点)
    - [コンセンサスメカニズムの変更](#コンセンサスメカニズムの変更)
    - [シャーディング](#シャーディング)
- [大枠の仕様について](#大枠の仕様について)
  - [2種類のアカウント](#2種類のアカウント)
  - [2種類のトランザクション](#2種類のトランザクション)
  - [トランザクションのライフサイクル](#トランザクションのライフサイクル)
  - [EVM (Ethereum Virtual Machine)](#evm-ethereum-virtual-machine)
- [まとめ](#まとめ)


# Ethereum 2.0 とは何か？

## 端的に言えばBitcoinの一般化である

別ファイルの見出しに対する引用はこのようにして行う

[端的に言えば`Bitcoinの一般化`である](../P02_ethereum/1_introduction.md#端的に言えばbitcoinの一般化である)
 
処理の一般化: 送金からプログラムへ
- 「AliceからBobに0.3BTC送金せよ」から 
- 「AliceからBobに0.3ETH送金せよ、ただしもしこの処理を既に4回行っていた場合、5回目以降はCarolに0.3ETH送金せよ」などへ
  - *Bitcoinのscriptでも似たようなことは可能だが、繰り返し構文が使えなかったり、scriptに状態(state) を保持することが出来なかったりと不便。
- このプログラムのことを「スマートコントラクト」と呼ぶ。
- なぜスマートでなぜコントラクトなのかは良くわからない。
- 恐らくふわっとしたノリで言っている。

管理対象の一般化: Bitcoinの移転記録 から アカウントが持つ状態 (state) の遷移記録 へ
- 「0.3BTC from Alice to Carol」から 
- 「Alice 0.7→0.4ETH; Carol 0→0.3ETH, コントラクト4→5回目」などへ

## この一般化を計算機科学の文脈でたとえると...

- 電卓と (プログラム内蔵方式の) コンピューター
- BitcoinとEthereum
  - "Bitcoinは電卓のようなものに思えた" by Vitalik Buterin
- Ethereumは「ワールドコンピューター」である。
- これを実現するためには、Bitcoinの様々な仕様を変更する必要がある。

## この一般化によって様々なアプリケーション開発が可能となる

- 分散型アプリケーション（DApps）
  - スマートコントラクト（プログラム）の集合体
- プログラムの実行や、その実行履歴・実行結果の管理をどこかの誰かがやってくれる
- ユーザーはその誰かを信用する必要がない 
  - e.g., 暗号資産の取引所 CEX vs DEX

## 1.0 から 2.0 での主な変更点

### コンセンサスメカニズムの変更

- スケーラビリティ問題への対処を主目的に、Ethereumは2022年の8月に互換性の無い形での大規模な仕様変更がおこなわれた （The Merge）
  - PoWからPoSへ (i.e., マイニングの廃止)
  - マイナーノード → バリデータノード
- これによりコンセンサスと報酬の仕組みが根本的に変わった
  - 伴わせてブロックのデータ構造も変化


### シャーディング

- シャーディング
  - 大規模なデータを小分けにして複数サーバーに分散保存し、パフォーマンスとスケーラビリティを向上させる、データベースの技術

- Ethereum におけるシャーディング
  - ネットワーク全体を複数に分割し、取引の検証を平行して行うことで、パフォーマンスとスケーラビリティを向上させる


# 大枠の仕様について

## 2種類のアカウント

- アカウントとはBitcoinにおけるアドレスのようなもの
- Ethereumには、2種類のアカウントが存在する
- `なぜ？: Bitcoinとは異なりスマートコントラクト用のプログラムを記録・保存しておく必要があるから (言い換えれば、BitcoinにはEOA的なアドレスしか存在しない) `

EOA (Externally Owned Account)
- 外部所有アカウント
- 人が管理する
- 秘密鍵を持つ
  - トランザクションを作ることができる
- 作成にコストがかからない

CA (Contract Account)
- スマートコントラクトのアカウント
- スマートコントラクトコードを持つ
- 人が管理していない
- 秘密鍵がない
  - トランザクションを作ることができない
- 作成にコストがかかる


## 2種類のトランザクション

- EOAから発せられるトランザクション(tx)は、2種類が存在する
- `なぜ？: EOAからCAに対しては「作成」と「実行」の2種類の操作が必要だから`

Message Call
- Bitcoinの送金に相当する、いわゆるトランザクション
- トランザクション実行後には、結果をまとめたレシートが発行される

Contract Creation
- コントラクトを新たに生成するためのトランザクション
- トランザクション実行後には、結果をまとめたレシートが発行される

よって送信元・送信先アカウントと組み合わせると、トランザクションは3 (+1) 分類
- EOA to EOA (Message Call) Bitcoinと同様、ETHの送金
- EOA to CA (Contract Creation) コントラクトを新たに生成
- EOA to CA (Message Call) 既存のコントラクトに引数を送り、プログラムを実行
- CA to CA (*Internal Transaction) 
  - CAが (プログラムに従って) 別のCAにETHを送金したり、新たなCAを作成する場合もある。
  - ただしあくまでトリガーはEOAによるMessage Call
  - これはブロックチェーンに記録されないし、トランザクションでないし、レシートも発行されない

## トランザクションのライフサイクル
- EOAが発するトランザクションの実行は、バリデーターノードが担う
- なんとなくEOAが実行していると思ってしまいがちなので注意！
- `なぜ？: トランザクションおよびその実行がもたらす状態遷移の「正しさ」について、分散的な合意形成を行いたいから`

基本的なライフサイクルはBitcoinと同様以下の通り  
```
EOAは、トランザクション(Message Call or Contract Creation)を各ノードに伝搬する
各ノードは、受け取ったトランザクションを独立に検証する
各ノードは、問題が無いトランザクションのみを溜め、かつ他のノードに伝搬する
バリデータノードたちは、確率的にブロックの提案 or 投票ノードに選ばれる
投票ノードたちは、正統と考えるチェーンの先端にあるブロックを宣言する
提案ノードは、任意のトランザクションおよび宣言をブロックに格納する
提案ノードは、ブロック内のトランザクションを実行する
提案ノードは、ブロックを既存のチェーンに含まれるいずれかのブロックに繋ぐ
提案ノードは、完成したブロックを各ノードに伝搬する
各ノードは、受け取ったブロックに問題が無いかを独立に検証する
各ノードは、問題が無いブロックのみを自身のチェーンに反映する
バリデータノードたちは、最も重いチェーンを「正しい」状態遷移の記録とする
```

## EVM (Ethereum Virtual Machine)
- 全てのバリデーターノードは、 EVM (Ethereum Virtual Machine) と呼ばれる仮想マシンを持つ
- `なぜ？: トランザクションの実行は、ほとんどの場合スマートコントラクトの実行を伴うから`
  - Bitcoinでは台帳の内容を (UTXOを通じて間接的に) 変更するだけだった
  - Ethereumではスマートコントラクト用のプログラムを読み込まなければならない

スマートコントラクトは、人間が書きやすいように Solidity (Ethereum用に開発された言語、Javascriptに近い) で記述する仕様になっている
- EVMは、トランザクションを実行する際にSolidityのプログラムコードをコンピューターが認識出来るbytecode形式へ変換する

# まとめ
- EthereumとはBitcoinの一般化である
- 一般化のためにアカウントとトランザクションがそれぞれ2種類になっている
- トランザクションのライフサイクルは基本的にBitcoinと同じ
- すべてのバリデーターノードはEVMと呼ばれる仮想マシンを持つ

