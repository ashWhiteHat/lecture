<center>

  <img src="../chart.drawio.svg" width="100%">

  **Ethereum2.0: スケーラビリティ向上**

</center>

Ethereumは、ブロックチェーン上でプログラム（スマートコントラクト）を実行するためのプロトコルであり、2014年にVitalik ButerinとGavin Woodによって提案されました。
スマートコントラクトを実行するために、EthereumはBitcoin Protocolの様々な仕様を変更しています。
では具体的に、どこを / どのように / なぜそのように 変更したのでしょうか？
そしてそもそも、スマートコントラクトなるものには一体どのような意義があるのでしょうか？
この資料は、はじめてEthereumに触れたときに誰しもが抱くであろう上記の疑問を解消し、その設計について体系的に理解できるようになることを目指して書かれています。

`Writer: @knskito`

`Donated by: `

- [Ethereum 2.0 とは何か？](#ethereum-20-とは何か)
  - [1.0 から 2.0 での主な変更点](#10-から-20-での主な変更点)
- [大枠の仕様について](#大枠の仕様について)
  - [トランザクションのライフサイクル](#トランザクションのライフサイクル)
- [まとめ](#まとめ)


# Ethereum 2.0 とは何か？

基本的なコンセプトはそれまでのEthereumと同様である

- [端的に言えばBitcoin Protocolの一般化である](../P02_ethereum/1_introduction.md#端的に言えばbitcoin-protocolの一般化である)
- [この一般化を計算機科学の文脈で捉えると...](../P02_ethereum/1_introduction.md#この一般化を計算機科学の文脈で捉えると)
- [この一般化によって様々なアプリケーション開発が可能となる](../P02_ethereum/1_introduction.md#この一般化によって様々なアプリケーション開発が可能となる)
 

## 1.0 から 2.0 での主な変更点

- [スケーラビリティ問題](../P02_ethereum/4_scalability.md#スケーラビリティ問題)に対処するために、2022年の9月に互換性の無い形での大規模な仕様変更 "The Merge" を行った
  - PoWからPoSへ (i.e., マイニングの廃止)
  - これによりコンセンサスと報酬の仕組みが根本的に変わった
  - 伴わせてブロックのデータ構造も変化
- この資料では、**新たなコンセンサスと報酬の仕組みについて詳細に説明する**

<center>
<img src="./img/the-merge.png" width="50%">

source: https://ethereum.org/en/roadmap/merge/
</center>


# 大枠の仕様について

以下の部分はそれまでのEthereumと同様である
- [2種類のアカウント](../P02_ethereum/1_introduction.md#2種類のアカウント)
- [2種類のトランザクション](../P02_ethereum/1_introduction.md#2種類のトランザクション)
- [EVM (Ethereum Virtual Machine)](../P02_ethereum/1_introduction.md#evm-ethereum-virtual-machine)

## トランザクションのライフサイクル

基本的なライフサイクルは以下の通り  
```
EOAは、トランザクション(Message Call or Contract Creation)を各ノードに伝搬する
各ノードは、受け取ったトランザクションを独立に検証する
各ノードは、問題が無いトランザクションのみを溜め、かつ他のノードに伝搬する
バリデータノードたちは、確率的にブロックの提案 or 投票ノードに選ばれる
投票ノードたちは、正統と考えるチェーンの先端にあるブロックを宣言する
提案ノードは、任意のトランザクションおよび宣言をブロックに格納する
提案ノードは、ブロック内のトランザクションを実行する
提案ノードは、ブロックを既存のチェーンに含まれるいずれかのブロックに繋ぐ
提案ノードは、完成したブロックを各ノードに伝搬する
各ノードは、受け取ったブロックに問題が無いかを独立に検証する
各ノードは、問題が無いブロックのみを自身のチェーンに反映する
バリデータノードたちは、最も重いチェーンを「正しい」状態遷移の記録とする
```
[以前のEthereumにおけるライフサイクル](../P02_ethereum/1_introduction.md##トランザクションのライフサイクル)との差分は以下の通り
``` diff
EOAは、トランザクション(Message Call or Contract Creation)を各ノードに伝搬する
各ノードは、受け取ったトランザクションを独立に検証する
各ノードは、問題が無いトランザクションのみを溜め、かつ他のノードに伝搬する
- マイナーノードは、溜まりから任意のトランザクションをブロックに格納する
+ バリデータノードたちは、確率的にブロックの提案 or 投票ノードに選ばれる
+ 投票ノードたちは、正統と考えるチェーンの先端にあるブロックを宣言する
+ 提案ノードは、任意のトランザクションおよび宣言をブロックに格納する
- マイナーノードは、ブロック内のトランザクションを実行する
+ 提案ノードは、ブロック内のトランザクションを実行する
- マイナーノードは、ブロックを既存のチェーンに含まれるいずれかのブロックに繋ぐ
+ 提案ノードは、ブロックを既存のチェーンに含まれるいずれかのブロックに繋ぐ
- マイナーノードは、PoW (Proof-of-Work) を経てブロックを完成させる
- マイナーノードは、完成したブロックを各ノードに伝搬する
+ 提案ノードは、完成したブロックを各ノードに伝搬する
+ 各ノードは、受け取ったブロックに問題が無いかを独立に検証する
各ノードは、受け取ったブロックに問題が無いかを独立に検証する
各ノードは、問題が無いブロックのみを自身のチェーンに反映する
Ethereumは、最も重いチェーンを「正しい」状態遷移の記録とする
```

- マイニングの廃止に伴い
  - マイナーノードからバリデーターノードに呼称が変更されている
  - PoWが削除されている
  - ブロックの提案や投票に関するプロセスが追加されている

# まとめ
- Ethereumはスケーラビリティ問題に対処すべく、大規模な仕様変更 "The Merge" を行った
- コンセンサスと報酬の仕組み、およびブロックの構造が大きく変化した
- これによりトランザクションのライフサイクルも大きく変化した

