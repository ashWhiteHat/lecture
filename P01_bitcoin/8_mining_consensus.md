# マイニングとコンセンサス

## 概要

- ブロックチェーンは改ざんできないことはわかったが、新しいブロックに含まれる情報がなぜ正しいものがはいるのか、その正しさはどのように全体でコンセンサスを得るのかをここで説明する

- 合意のプロセス
  - [分散化コンセンサス](#分散化コンセンサス)

- トランザクション検証
  - [独立したトランザクション検証](#独立したトランザクション検証)
  - [マイニングノード](#マイニングノード)
  - [ブロックへのトランザクション集積](#ブロックへのトランザクション集積)
  - [トランザクション手数料](#トランザクション手数料)
  - [Coinbaseトランザクション概要](Coinbaseトランザクション概要)
- マイニング
  - [マイニング報酬と手数料](#マイニング報酬と手数料)
  - [Coinbaseトランザクションの構造](#coinbaseトランザクションの構造)
  - [ブロックヘッダの構築](#ブロックヘッダの構築)
  - [ブロックのマイニングーProof-of-Workアルゴリズム](#ブロックのマイニングーproof-of-workアルゴリズム)
  - [マイニングのプログラム例](#マイニングのプログラム例)
  - [difficultyターゲットの表現](#difficultyターゲットの表現)
  - [difficultyターゲットの更新](#difficultyターゲットの更新)
  - [マイニングに成功したら](#マイニングに成功したら)
- ブロック検証
  - [新しいブロックの検証](#新しいブロックの検証)
  - [ブロックのチェーンの組み立てと選択](#ブロックのチェーンの組み立てと選択)
  - [ブロックチェーンフォーク](#ブロックチェーンフォーク)
  - [マイニングとハッシュ化競争](#マイニングとハッシュ化競争)
  - [マイニングプール](#マイニングプール)
  - [コンセンサス攻撃](#コンセンサス攻撃)
  
## 分散化コンセンサス

- 中央管理者なしでの真実と合意の形成

中央集権型のシステムでは、その運営者を信用している例として、Visaの支払いが挙げられる。しかし、分散化されたコンセンサスにおいては、個々が独立して動いていても全体として最適に動くことが求められる。これはコンセンサスの創発とも呼ばれ、以下の4つの相互作用で成り立つ

 1. 独立したトランザクション検証
すべてのフルノードは包括的なリストに基づくトランザクションの検証を行う。各ノードは独自の検証方法を共有し、独立して検証を行う

 2. 独立したトランザクション集積
PoWアルゴリズムによる計算と結びついた、マイニングノードによるトランザクションの集積が行われる。マイニングノードは自由にブロックにトランザクションを追加できる

 3. 独立した新規ブロック検証とブロックチェーンへの埋め込み
すべてのノードは新しいブロックを検証し、そのブロックを自身が持つブロックチェーンに取り込む

 4. 独立したブロックチェーン選択
各ノードはPoWを通じて証明された最も多くの累積計算量を持つブロックチェーンを選択し、これにより最長のチェーンが形成される

## 独立したトランザクション検証

- 各ノードで、伝搬前にトランザクションが検証され、不正なトランザクションは伝搬されない

- ノードが確認する主な事項は以下
  
 1. そのトランザクションのインプットを過去に払ってないこと
二重支払いを防ぐ。支払い済みのインプットを再度支払うことはできない

 2. そのインプットの合計額がアウトプットの合計額以上になっていること
新たにビットコインが作成されてないかを確認する(coinbaseトランザクションは例外)

 3. ScriptSigが前のScriptPubKeyのアンロックに成功していること
連結したスクリプトが有効であることを確認する

## マイニングノード

- ノードのうちマイニングを行っているノードで、マイナーと呼ばれる
  - 必ずしもフルノードでなくともよい

- マイニングプールではフルノードなしにマイニングする
  - 一般的には、フルノードとなりすべてブロックの検証が可能な状態のブロックチェーンに対してマイニングする

- 万が一マイニングに成功し生成ブロックが他のノードで検証に失敗するとブロックチェーンに取り込まれなくなってしまう

- マイニングノードはマイニングに成功すると、マイニング報酬とそのブロックに含まれているトランザクションの手数料すべてを受け取る

- 新規ブロックが他のノードから伝搬された場合、現在のマイニングに負けたことを意味するため、次のブロックのマイニングを始める必要がある

## ブロックへのトランザクション集積

- マイニングノードは候補ブロックを作る
  - 次の新しいブロックとしてトランザクションのリストを持ったブロック

- トランザクションは自身のトランザクションプールから選ぶ

- 候補ブロックのナンス値を見つける（PoW）

- 昔は、候補ブロックに入れるトランザクションは，優先度が決められていた
  - その優先度に従って候補ブロックに入れるトランザクションが決められた

## トランザクション手数料

- トランザクション優先度はトランザクションサイズと手数料、Ageから計算される．
  - ノードが受け取れる手数料を多くする．

  - 1MBというブロックサイズに入れられるだけのトランザクションを入れる

  - 古いUTXOから使用される

- 最初の50KB
  - Priorityに従ったトランザクション
  - Priority = Sum (Value of Input * Input Age) / Transaction Size
    - Value of Input ・・・ Inputを単位satoshiで．（1BTC=1億satoshi）
    - Input Age ・・・ InputのUTXOが含まれるブロックから現在のブロック高の差

- 残り
  - トランザクション手数料をデータサイズで割った順

※ 上記は過去、トランザクションが少なかった頃採用されていたルールの様子。現在はすべてトランザクション手数料を見て判断されている

## Coinbaseトランザクション概要

- 各ブロックの最初に要求されるトランザクションをcoinbaseトランザクションもしくはgenerationトランザクションと呼ぶ。

- マイナー自身への支払いとなる、ブロック内の他のトランザクションの全ての手数料とブロック報酬が含まれる
  
- インプットはcoinbaseと呼ばれるデータ領域になっている
  - マイニング報酬は無から生み出される、すなわち対応するUTXOはない
  - エクストラナンスとしても使用される
- アウトプットはマイナーのアドレスへ（公開鍵を含むロッキングスクリプト）

## マイニング報酬と手数料

- マイニング成功時に得られる報酬は、マイニング報酬＋手数料

- マイニング報酬

  - マイニング報酬とはすなわちビットコインの新規発行

  - 210,000ブロックごとに報酬は半減する

  - 約4年、1ブロック=10分

  - 最初50BTCで、2020年5月には6.25BTCになった

  - 2024/01現在1BTC≒600万円なので約3,700万円

  - 最終的にマイニング報酬が0になるのは2140年ごろ、そのころになると1satoshiを切る。そのとき総発行量は2100万BTCとなる

- 手数料

  - Total Fees = Sum(Inputs) – Sum(Outputs)

  - ブロック内に入れるトランザクション全体の手数料総和

## Coinbaseトランザクションの構造

- インプットは必ず一つのみ、その一つのインプットの前のトランザクションIDは32バイトの00である、その一つのインプットの前のトランザクションインデックスはffffffffである、という3つの条件がcoinbaseトランザクションか否かを決定づける

- Coinbaseトランザクションのインプットはアンロッキングスクリプトの代わりに任意のデータを入れられる

  - Genesisブロックの新聞見出し

  - 2バイト～100バイト

- 最初にブロック高を入れ、そのあとは任意のデータ

  - 後述するように、エキストラナンスとしても使用される

## ブロックヘッダの構築

- ブロックヘッダはブロックに含まれるトランザクションに関するメタデータ

- マイニングに成功した場合、ブロックヘッダを構築する必要がある
  - 普通のブロックヘッダ

  - マイナーが作成

  - 間違えると無効になって報酬が損するので間違えないように作成する必要がある
  
- Target PoWのDifficulty Target
- Nounce マイニングで求める値。マイナーがPoWを探す際に変更される

| Size       | Field               | Description                                                       |
|------------|---------------------|-------------------------------------------------------------------|
| 4 bytes    | Version             | A version number to track software/protocol upgrades.             |
| 32 bytes   | Previous Block Hash | A reference to the hash of the previous (parent) block in the chain. |
| 32 bytes   | Merkle Root         | A hash of the root of the merkle tree of this block’s transaction. |
| 4 bytes    | Timestamp           | The approximate creation time of the block.                       |
| 4 bytes    | Difficulty Target   | The proof of work algorithm difficulty target for this block.     |
| 4 bytes    | Nonce               | A counter used for the proof of work algorithm.                  |

## ブロックのマイニングーProof-of-Workアルゴリズム

- トランザクションリストを選び、ブロックヘッダを構築したら、候補ブロックに対してあとはやることはマイニングのみ
- ナンス値(4 bytes)を発見する
- ブロックハッシュの頭にゼロがいくつか並ぶもとの文字列を求める
  - ブロックヘッダのダブルハッシュ値(SHA256 2回)
- ゼロがいくつ必要かはその時点のターゲットによる
- ハッシュ値がターゲット未満になるようなナンス値を探す
  - 例えば
  - 0x0000000000000003A30C00000000000000000000000000000000000000000000
  - というターゲットの場合、ブロックハッシュの値がこの値より小さい必要がある
  
## マイニングのプログラム例

- ナンス値を変えてブロックハッシュを求めてターゲット以下になるか、ということを繰り返して行
う以外方法がない
  - ハッシュ関数は不可逆で、元の値を少しでも変えるとハッシュ値は大幅に変わる
- Pythonの実装例：

```python
def proof_of_work(difficulty):
    # nonceは4byte
    for nonce in range(2 ** (4 * 8)):
        header = get_header(nonce)
        blockhash = double_hash(header)
        if blockhash < difficulty:
            return nonce
    raise NotFoundException()
```

## difficultyターゲットの表現

- Difficulty targetはヘッダに含まれる
  - 4 Bytes
  - 16進で、初めの1バイトが指数(exponent)、残りの3バイトが係数(coefficient)
  
## difficultyターゲットの更新

- ブロック生成時間が10分に保たれるようにターゲットが一定間隔で調整される

- 「10分」という間隔は、何十年にもわたって保ちたい

  - コンピュータの急激な進化にも耐えられるようにする

  - マイニング参加者、コンピュータ台数も変化する
  
- ターゲットはブロックが10分間隔で生成されるように２週間ごと（2016ブロックごと）に調整され
る

> New Target = Old Target * (Actual Time of Last 2016 Blocks / 20160 minutes)

- ターゲットが極端に動きすぎないように、調整の際、最大4倍、最小で1/4以内になるようになっ
ている

## マイニングに成功したら

- 候補ブロックが正しい新しいブロックとして生成できたということになる

- これは、いち早く他のノードに伝搬すべき
  - 他のマイナーも同時期にマイニングに成功している可能性があり、そちらが採用されてし
まうと自分のマイニングしたブロックが無効になってしまうため
  - もらえるはずだった報酬がもらえなくなってしまう

- 他のノードはどのように新しいブロックの検証をやっているのか？

## 新しいブロックの検証

- 各ノードは受け取った新規ブロックについて、他のノードへ伝搬する前に独立に検証を行う

- **ブロックのデータ構造が正しいこと**

- **ブロックハッシュがターゲットより小さいこと**

- **ブロックのタイムスタンプが、ノードが持つ時間より2時間未来の時間よりも小さいこと**

- **ブロックサイズが受け入れられる制限内(1MB)であること**

- **最初のトランザクションのみがcoinbaseトランザクションであること**

- **ブロックに含まれるすべてのトランザクションが、「独立したトランザクション検証」のチェックリストをすべて満たすこと**

- この検証を全ノードが行うことで不正が行われないようになっている
  - もし受け取ったノードがブロック内の情報を書き換えたとしても他のノードでの検証に失敗
する
  - もし受け取る一瞬前に自分もマイニングに成功していた場合
    - メインチェーンではなくセカンダリーチェーンにつなげる

## ブロックのチェーンの組み立てと選択

- ブロックの検証後、チェーンへの追記が試行される．
  - 無効なブロックは破棄される

- 各ノードは3つのブロックセットを持つ
  - メインチェーン
    - 最大長を持つ

  - セカンダリチェーン
    - メインチェーンから分岐した兄弟チェーンも、将来的にメインチェーンに置き換わる
可能性があるため保持される

- オーファンブロックプール
  - 親が不明なブロック

- Previous Block Hashを見てどのチェーンに属するものか判断する
  - 多くの場合はメインチェーンの最新ブロックに

- セカンダリチェーンを伸ばすブロックを受け取り、結果としてメインチェーンが置き換わることも
ある
  - 最長チェーンが入れ替わる

- 親が見つからないが検証を通るブロックを受け取ると、親チェーンの情報を受け取るまでの間
オーファンブロックプールへ保存される

- オーファンブロックはブロック受け取り順序が逆になった際によく生じる

## ブロックチェーンフォーク

- 伝達ラグによってフォークがおこる．世界中に存在するノードで同時に伝搬を完了させるのは不可
能．

## マイニングとハッシュ化競争

- CPU → GPU/FPGA (2011年) → ASIC (2013年) と特化ハードウェアへ移行してきた．

  - CPU： 普通のパソコンに搭載

  - GPU： GPGPUで高速な並列計算が可能

  - FPGA: 回路をプログラム可能

  - ASIC：専用回路

- ハッシュレート

  - ビットコインネットワーク全体の毎秒総生成ハッシュ数

- ハードウェアの進化とマイニングノードの増加により、指数関数的に増加している

- これに伴いdifficultyも増加するので、新規参入は困難
  - 手元のPCで気軽にマイニングしても難しい

## マイニングプール

- 複数人でマイニングを分担する仕組み
- 複数人のマイナーを集めて一緒にマイニングを行い、報酬を分配する
- マイナーは報酬額は減るが、日々平均的な報酬を得られるようになる

- マネージドプール
  - 管理者がいるマイニングプール
  - 管理者がプールマイニングプロトコルの管理や、フルノードのメンテナンスなどを行う．
  - 報酬は管理者が受け取って，参加者に分配する
  - 管理者は、報酬の一部を手数料として受けとる

- P2PPool
  - マネージドプールは管理者によって不正がなされる可能性もある

  - P2PPoolではシェアチェーンと呼ばれる小型ブロックチェーンのようなチェーンを用いて
参加者はシェアチェーンを掘る
    - ビットコインブロックチェーンより低いDifficultyが設定される
  - そのうち、ビットコインブロックチェーンでのDifficultyを充足させるブロックが発見されたら
それを採用する

  - 報酬の分配ルールもシェアチェーンで管理され特定の誰かが不正できなくなっている

## コンセンサス攻撃

- 特定のマイナーがハッシュレートの多くを占めていると、先端のブロック伸長をある程度操作す
ることが可能になる
  - 2ブロック分マイニングできるくらいのハッシュレートを持っていれば、1ブロック分のフォー
クは無効化できる

- 51%アタックと呼ばれる
  - 6ブロック以上を無効化できる可能性がある
  - 特定アドレスが関与する支払いを無効化するために意図的にフォーク
  - 51%というのは必ずしもハッシュレートの51%が必要というわけではない

- マイニングプールが不正を行おうとするとかなり問題

## まとめ

- 新しいブロック（トランザクション）が正しいといかにしてコンセンサスを得るか
  - 皆が同じルールに基づいて検証を行っている
  - もしこの検証を通らないブロックを伝搬させようとしても他の多くのノードで無効と判断され
る
  - 最長ブロックチェーンが残っていくため、いち早く正しく長いチェーンを作ることがマイナーのインセンティブになっている

- マイニング
  - PoWの解を見つければ報酬を得られる
    -2024/01現在6.25BTC=約3,700万円（1BTC=600万円）

  - マイニング報酬を得たいがためにすべてのノードは「正しい」振舞いをする
    - 正しくブロックを作る
    - 正しくブロックを検証する

- コンセンサスアタック
  - ハッシュレートの多くの割合を一部の人が持ってしまうとコンセンサスメカニズムを破壊で
きる（51%攻撃）
  - マイニングプールがそれができる傾向があるが、P2PPoolなど管理者不在の方法も考案さ
れている
