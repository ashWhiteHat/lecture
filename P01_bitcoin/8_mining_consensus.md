# マイニングとコンセンサス

## 概要

- ブロックチェーンは改ざんできないことはわかったが、新しいブロックに含まれる情報がなぜ正しいものがはいるのか、その正しさはどのように全体でコンセンサスを得るのかをここで説明する

- 合意のプロセス

  - [分散化コンセンサス](#分散化コンセンサス)

- トランザクション検証
  - [独立したトランザクション検証](#独立したトランザクション検証)
  - [マイニングノード](#マイニングノード)
  - [ブロックへのトランザクション集積](#ブロックへのトランザクション集積)
  - [トランザクション手数料](#トランザクション手数料)
  - [Coinbase トランザクション概要](Coinbaseトランザクション概要)
- マイニング
  - [マイニング報酬と手数料](#マイニング報酬と手数料)
  - [Coinbase トランザクションの構造](#coinbaseトランザクションの構造)
  - [ブロックヘッダの構築](#ブロックヘッダの構築)
  - [ブロックのマイニングー Proof-of-Work アルゴリズム](#ブロックのマイニングーproof-of-workアルゴリズム)
  - [マイニングのプログラム例](#マイニングのプログラム例)
  - [difficulty ターゲットの表現](#difficultyターゲットの表現)
  - [difficulty ターゲットの更新](#difficultyターゲットの更新)
  - [マイニングに成功したら](#マイニングに成功したら)
- ブロック検証
  - [新しいブロックの検証](#新しいブロックの検証)
  - [ブロックのチェーンの組み立てと選択](#ブロックのチェーンの組み立てと選択)
  - [ブロックチェーンフォーク](#ブロックチェーンフォーク)
  - [マイニングとハッシュ化競争](#マイニングとハッシュ化競争)
  - [マイニングプール](#マイニングプール)
  - [コンセンサス攻撃](#コンセンサス攻撃)

## 分散化コンセンサス

- 中央管理者なしでの真実と合意の形成

中央集権型のシステムでは、その運営者を信用している例として、Visa の支払いが挙げられる。しかし、分散化されたコンセンサスにおいては、個々が独立して動いていても全体として最適に動くことが求められる。これはコンセンサスの創発とも呼ばれ、以下の 4 つの相互作用で成り立つ

1.  独立したトランザクション検証
    すべてのフルノードは包括的なリストに基づくトランザクションの検証を行う。各ノードは独自の検証方法を共有し、独立して検証を行う

2.  独立したトランザクション集積
    PoW アルゴリズムによる計算と結びついた、マイニングノードによるトランザクションの集積が行われる。マイニングノードは自由にブロックにトランザクションを追加できる

3.  独立した新規ブロック検証とブロックチェーンへの埋め込み
    すべてのノードは新しいブロックを検証し、そのブロックを自身が持つブロックチェーンに取り込む

4.  独立したブロックチェーン選択
    各ノードは PoW を通じて証明された最も多くの累積計算量を持つブロックチェーンを選択し、これにより最長のチェーンが形成される

- なぜコンセンサスの創発と呼ばれるのか
  Bitcoin のコンセンサスの流れ：マイナーが主張している内容を、各ノードが検証し、ノード全体の合意という形でその内容は認証される
  このコンセンサスは、全参加者により常に行われている検証によって創り出されている。このような方法によるコンセンサスは、創発的（emergent）コンセンサスと呼ばれる。
  このコンセンサスの方式が、情報の信頼性を保証する別の仕組み、PKI と最も違う点である。
  PKI は、信頼できる第三者を利用して「事実の主張」を確認する手段である。PKI では，主体が主張している内容を認証局などが確認のうえで事実として承認し、電子署名によって認証していた。

## 独立したトランザクション検証

- 各ノードで、伝搬前にトランザクションが検証され、不正なトランザクションは伝搬されない

- ノードが確認する主な事項は以下

1. そのトランザクションのインプットを過去に支払ってないこと 二重支払いの防止。支払い済みのインプットを再度支払うことはできない

2. そのインプットの合計額がアウトプットの合計額以上になっていること 新たにビットコインが作成されてないかを確認する(coinbase トランザクションは例外)

3. ScriptSig が前の ScriptPubKey のアンロックに成功していること 連結したスクリプトが有効であることを確認する(ほとんどすべてのトランザクションにおいては ScriptSig にある 1 つ以上の署名が有効であると確認することを意味する)

- インプットの支払い状況の確認

1. 二重支払い防止のため、ノードは各インプットが存在すること及び過去に使われてないことを確認する(UTXO セットにアクセスし、UTXO を追跡することであるインプットが二重支払いかどうか検証可能)
2. UTXO は Unspent Transaction Outputs の略。インプットに未だに払われていないものが入っていなければ、二重支払いであるということが判明する。

- インプットの合計額とアウトプットの合計額の確認

1. ノードはインプットの合計がアウトプットの合計以上であることも確認する(これによりトランザクションが新たなコインを作成することを防ぐ)(後述する coinbase トランザクションは例外)

- 署名の確認

1. トランザクションは通常は 1 インプットにつき少なくとも 1 つ以上の署名を持つ。ここで署名ハッシュを取得する部分において、署名は ScriptSig の一部であるためにトランザクションのシリアライズをハッシュすることができない(署名は ScriptSig の一部であり、署名自体に署名できないから)
2. 代わりに、インプットごとに異なる署名ハッシュを計算する(署名前にトランザクションを変更する)
3. 全ての ScriptSig を空にする
4. 署名されるインプットの ScriptSig を前の ScriptPubKey に置き換える
5. ハッシュタイプを付加する(4 バイトのハッシュタイプを末尾に加えることで署名が正当性を認める内容を指定する)

- このような手順を踏むことでトランザクション検証プロセスが行われる。署名ハッシュのアルゴリズム自体は非効率的で無駄が多いため、Segwit 以降は所謂二次ハッシュ問題は別手法により解決されている

その他の補足説明

- インプットのいずれも hash=0, N=-1 でないか(coinbase トランザクションでないか)
  - coinbase トランザクションは新しく生成されたビットコインと、ブロックを採掘することによって得られるトランザクション手数料を採掘者（マイナー）に報酬として与える特別なトランザクション。
  - トランザクション ID（TxID）が全て 0 で、過去のトランザクションを参照しないことを意味し、出力インデックス（vout）が-1 となる。
- nLockTime は INT_MAX 以下か
  - nLockTime は、トランザクションを遅延させる時間やブロックの高さを示している。トランザクションが意図した時間やブロック高さまで正しく遅延されるように確認している。
  - LockTime は発行されたトランザクションがチェーン上に保存される前に、それを他のノードが確認することを可能にする。LockTime を長くすると、そのトランザクションがよく伝播した上でチェーンに追加されるので、フォークが減る一方、コンセンサスの時間がかかる事になる。
- オーファントランザクションとは
  - オーファントランザクション（Orphan Transaction）は、ビットコインネットワークにおいて、その入力となるトランザクション（親トランザクション）がまだネットワークに認識されていない、あるいは利用可能なブロックチェーンの履歴に含まれていないトランザクションを指す
  - オーファントランザクションは、ビットコインネットワーク上でトランザクションが非順序で伝播するときに発生することがある。
  - 近年では、ビットコインのプロトコルや実装の改善により、オーファントランザクションが発生する頻度は減少している。
- なぜトランザクション手数料が少なすぎるといけないのか
  - スパム攻撃の防止
    - ネットワークを圧迫し、正当なトランザクションの処理を遅くすることができる
  - 手数料はマイナーにとっての貴重な収入源
    - ネットワークを維持するインセンティブになるので、低すぎない手数料でないと却下する。
- 各インプットのアンロッキングスクリプトは，対応したアウトプットのロッキングスクリプトを解除できるか．
  ロッキングスクリプトは、トランザクションのアウトプットに配置され、その資金が使用される条件を定義する
  アンロッキングスクリプトは、トランザクションのインプットに含まれ、対応するアウトプットのロッキングスクリプトに設定された条件を満たすために使用される tt
- COINBASE_MATURITY(100)
  - COINBASE_MATURITY とは、coinbase トランザクションによって生成されたビットコイン）が使えるようになるまでの承認の数である
  - ビットコインの場合、その値は 100 であり、ビットコインが採掘されてから、そのビットコインを使って他のトランザクションを行うことができるようになるまで、約 100 ブロック分（約 16 時間 40 分から 17 時間）の時間が必要。
  - 二重支払いを防ぐ
    - 採掘者が一時的に生成したブロックを使ってトランザクションを実行し、その後にそのブロックがオーファン（孤立）ブロックとなった場合、ビットコインは事実上二重で使われることになってしまう。
  - ネットワークの安定性確保
    - チェーンに保存されることが確定するまで時間をおくことができる。
  - ビットコインの価格が急激に変動するのを防ぐ。

## マイニングノード

- ノードのうちマイニングを行っているノードで、マイナーと呼ばれる

  - 必ずしもフルノードでなくともよい

- マイニングプールではフルノードなしにマイニングする

  - 一般的には、フルノードとなりすべてブロックの検証が可能な状態のブロックチェーンに対してマイニングする

- 万が一マイニングに成功し生成ブロックが他のノードで検証に失敗するとブロックチェーンに取り込まれなくなってしまう

- マイニングノードはマイニングに成功すると、マイニング報酬とそのブロックに含まれているトランザクションの手数料すべてを受け取る

- 新規ブロックが他のノードから伝搬された場合、現在のマイニングに負けたことを意味するため、次のブロックのマイニングを始める必要がある

## ブロックへのトランザクション集積

トランザクションの確定を保証するプロセスとして、ネットワークのセキュリティを維持する、必要がある。

- マイニングノードは候補ブロックを作る

  - 次の新しいブロックとしてトランザクションのリストを持ったブロック

    - ブロックのヘッダには、前のブロックのハッシュ、タイムスタンプ、ナンス値、難易度ターゲットなどの情報が含まれる。

- トランザクションは自身のトランザクションプールから選ぶ

  - ここにはそのノードが受け取ったがまだブロックチェーンに取り込まれていないトランザクションが格納される。他のノードのトランザクションプールとは異なることがある。

- 候補ブロックのナンス値を見つける（PoW）(ナンス値はマイナーが PoW を探す際に変更される)

  - これはマイニングの難易度（難易度ターゲット）によって変化する。

- 候補ブロックに入れるトランザクションは優先度が決められる

  - 手数料、CoinAgePriority(今は使われていない)などがある。

- ブロックサイズとトランザクション容量

  - ブロックのサイズには上限がある。現在は 1MB の基本ブロックサイズに加えて、SegWit による拡張部分があり、倍程度になっている。

## トランザクション手数料

- トランザクション優先度はトランザクションサイズと手数料、Age から計算される．

  - ノードが受け取れる手数料を多くする．

  - 1MB というブロックサイズに入れられるだけのトランザクションを入れる

  - 古い UTXO から使用される

- 最初の 50KB

  - Priority に従ったトランザクション
  - Priority = Sum (Value of Input \* Input Age) / Transaction Size
    - Value of Input ・・・ Input を単位 satoshi で．（1BTC=1 億 satoshi）
    - Input Age ・・・ Input の UTXO が含まれるブロックから現在のブロック高の差

- 残り
  - トランザクション手数料をデータサイズで割った順

※ 上記は過去、トランザクションが少なかった頃採用されていたルールの様子。現在はすべてトランザクション手数料を見て判断されている

- トランザクション手数料の意義

  - そもそもマイナーにはブロックを小さく保とうとする明確な動機が存在する(ブロックにトランザクションを追加すればするほど、ブロックを伝播する時間が長くなり、他のマイナーによって次のブロックが先に見つかるリスクが増え、ブロック間のマイニング競争で不利になる)
  - しかしながら、ブロックにトランザクションを追加するたびにマイナーが得る収入が増えるとすると、マイナーの競争力の低下を補うインセンティブが発生する
  - これはあくまでひとつの説明だが、実際に効力をなしている

- ビットコインのコンセンサスルールのひとつに、任意の非 coinbase トランザクションにおいてはインプットの合計 ≧ アウトプットの合計というものがある。トランザクションのコストがゼロであるならば、マイナーがトランザクションをブロックに取り込むインセンティブがなくなるから

  - 手数料はマイナーがトランザクションをブロックに含める動機になる、故に高い手数料は早い処理速度に繋がる。

- このように、インセンティブ設計ひとつ取っても中央管理者抜きでビットコインシステムが成り立つ基盤となっている

- 元々は Coin Age Priority というトランザクションの手数料と優先度を定めたロジックが存在したが、今はない。現在では、トランザクションを早く通す(早くブロックに取り込まれる)ためにはいくつかの要因があるが、手数料の支払い額が優先度の大きな判断基準となっている

  - その優先度に従って候補ブロックに入れるトランザクションが決められる。
  - 現在はトランザクションの選択は主に手数料に基づいている。
  - 以前は手数料に加えて、Coin Age Priority（トランザクションに含まれるビットコインが最後に動いた時間）に基づいていた。

- ブロック報酬が時間とともに半減していく中で、トランザクション手数料はマイナーにとってますます重要な収入源となる。これは、ビットコインネットワークが長期的に持続可能であるための基盤となる。

## Coinbase トランザクション概要

- 各ブロックの最初に要求されるトランザクションを coinbase トランザクションもしくは generation トランザクションと呼ぶ。

- マイナー自身への支払いとなる、ブロック内の他のトランザクションの全ての手数料とブロック報酬が含まれる

- インプットは coinbase と呼ばれるデータ領域になっている

  - マイニング報酬は無から生み出される、すなわち対応する UTXO はない
  - その代わりにこの特別なデータ領域に任意のデータを含めることができる（しばしば、マイニングプールやその他のメッセージが含まれる）
  - エクストラナンスとしても使用される -エクストラナンスは、マイナーがナンス値の範囲(32bit, 2^32 通り)を超えて計算を続けることを可能にするための追加のパラメータ

- アウトプットはマイナーのアドレスへ（Coinbase のロッキングスクリプトは、マイナーが報酬を支払いに使用できるようにするために、公開鍵を基にしたものとなっている）

## マイニング報酬と手数料

- マイニング成功時に得られる報酬は、マイニング報酬＋手数料

- マイニング報酬

  - マイニング報酬とはすなわちビットコインの新規発行

  - 210,000 ブロックごとに報酬は半減する

  - 約 4 年、1 ブロック=10 分

  - 最初 50BTC で、2020 年 5 月には 6.25BTC になった

  - 2024/01 現在 1BTC≒600 万円なので約 3,700 万円

  - 最終的にマイニング報酬が 0 になるのは 2140 年ごろ、そのころになると 1satoshi を切る。そのとき総発行量は 2100 万 BTC となる

- 手数料

  - Total Fees = Sum(Inputs) – Sum(Outputs)

  - ブロック内に入れるトランザクション全体の手数料総和

## Coinbase トランザクションの構造

- インプットは必ず一つのみ、その一つのインプットの前のトランザクション ID は 32 バイトの 00 である、その一つのインプットの前のトランザクションインデックスは ffffffff である、という 3 つの条件が coinbase トランザクションか否かを決定づける

- Coinbase トランザクションのインプットはアンロッキングスクリプトの代わりに任意のデータを入れられる

  - Genesis ブロックの新聞見出し

  - 2 バイト～ 100 バイト

- 最初にブロック高を入れ、そのあとは任意のデータ

  - 後述するように、エキストラナンスとしても使用される

## ブロックヘッダの構築

- ブロックヘッダはブロックに含まれるトランザクションに関するメタデータ

- マイニングに成功した場合、ブロックヘッダを構築する必要がある

  - 普通のブロックヘッダ

  - マイナーが作成

  - 間違えると無効になって報酬が損するので間違えないように作成する必要がある

- Target PoW の Difficulty Target
- Nounce マイニングで求める値。マイナーが PoW を探す際に変更される

| Size     | Field               | Description                                                          |
| -------- | ------------------- | -------------------------------------------------------------------- |
| 4 bytes  | Version             | A version number to track software/protocol upgrades.                |
| 32 bytes | Previous Block Hash | A reference to the hash of the previous (parent) block in the chain. |
| 32 bytes | Merkle Root         | A hash of the root of the merkle tree of this block’s transaction.   |
| 4 bytes  | Timestamp           | The approximate creation time of the block.                          |
| 4 bytes  | Difficulty Target   | The proof of work algorithm difficulty target for this block.        |
| 4 bytes  | Nonce               | A counter used for the proof of work algorithm.                      |

## ブロックのマイニングー Proof-of-Work アルゴリズム

- トランザクションリストを選び、ブロックヘッダを構築したら、候補ブロックに対してあとはやることはマイニングのみ
- ナンス値(4 bytes)を発見する
- ブロックハッシュの頭にゼロがいくつか並ぶもとの文字列を求める
  - ブロックヘッダのダブルハッシュ値(SHA256 2 回)
- ゼロがいくつ必要かはその時点のターゲットによる
- ハッシュ値がターゲット未満になるようなナンス値を探す
  - 例えば
  - 0x0000000000000003A30C00000000000000000000000000000000000000000000
  - というターゲットの場合、ブロックハッシュの値がこの値より小さい必要がある

## マイニングのプログラム例

- ナンス値を変えてブロックハッシュを求めてターゲット以下になるか、ということを繰り返して行
  う以外方法がない
  - ハッシュ関数は不可逆で、元の値を少しでも変えるとハッシュ値は大幅に変わる
- Python の実装例：

```python
def proof_of_work(difficulty):
    # nonceは4byte
    for nonce in range(2 ** (4 * 8)):
        header = get_header(nonce)
        blockhash = double_hash(header)
        if blockhash < difficulty:
            return nonce
    raise NotFoundException()
```

## difficulty ターゲットの表現

- Difficulty target はヘッダに含まれる
  - 4 Bytes
  - 16 進で、初めの 1 バイトが指数(exponent)、残りの 3 バイトが係数(coefficient)

## difficulty ターゲットの更新

- ブロック生成時間が 10 分に保たれるようにターゲットが一定間隔で調整される

- 「10 分」という間隔は、何十年にもわたって保ちたい

  - コンピュータの急激な進化にも耐えられるようにする

  - マイニング参加者、コンピュータ台数も変化する

- ターゲットはブロックが 10 分間隔で生成されるように２週間ごと（2016 ブロックごと）に調整され
  る

> New Target = Old Target \* (Actual Time of Last 2016 Blocks / 20160 minutes)

- ターゲットが極端に動きすぎないように、調整の際、最大 4 倍、最小で 1/4 以内になるようになっ
  ている

## マイニングに成功したら

- 候補ブロックが正しい新しいブロックとして生成できたということになる

- これは、いち早く他のノードに伝搬すべき

  - 他のマイナーも同時期にマイニングに成功している可能性があり、そちらが採用されてし
    まうと自分のマイニングしたブロックが無効になってしまうため
  - もらえるはずだった報酬がもらえなくなってしまう

- 他のノードはどのように新しいブロックの検証をやっているのか？

## 新しいブロックの検証

- 各ノードは受け取った新規ブロックについて、他のノードへ伝搬する前に独立に検証を行う

- **ブロックのデータ構造が正しいこと**

- **ブロックハッシュがターゲットより小さいこと**

- **ブロックのタイムスタンプが、ノードが持つ時間より 2 時間未来の時間よりも小さいこと**

- **ブロックサイズが受け入れられる制限内(1MB)であること**

- **最初のトランザクションのみが coinbase トランザクションであること**

- **ブロックに含まれるすべてのトランザクションが、「独立したトランザクション検証」のチェックリストをすべて満たすこと**

- この検証を全ノードが行うことで不正が行われないようになっている
  - もし受け取ったノードがブロック内の情報を書き換えたとしても他のノードでの検証に失敗
    する
  - もし受け取る一瞬前に自分もマイニングに成功していた場合
    - メインチェーンではなくセカンダリーチェーンにつなげる

## ブロックのチェーンの組み立てと選択

- ブロックの検証後、チェーンへの追記が試行される．

  - 無効なブロックは破棄される

- 各ノードは 3 つのブロックセットを持つ

  - メインチェーン

    - 最大長を持つ

  - セカンダリチェーン - メインチェーンから分岐した兄弟チェーンも、将来的にメインチェーンに置き換わる
    可能性があるため保持される

- オーファンブロックプール

  - 親が不明なブロック

- Previous Block Hash を見てどのチェーンに属するものか判断する

  - 多くの場合はメインチェーンの最新ブロックに

- セカンダリチェーンを伸ばすブロックを受け取り、結果としてメインチェーンが置き換わることも
  ある

  - 最長チェーンが入れ替わる

- 親が見つからないが検証を通るブロックを受け取ると、親チェーンの情報を受け取るまでの間
  オーファンブロックプールへ保存される

- オーファンブロックはブロック受け取り順序が逆になった際によく生じる

## ブロックチェーンフォーク

- 伝達ラグによってフォークがおこる．世界中に存在するノードで同時に伝搬を完了させるのは不可
  能．

## マイニングとハッシュ化競争

- CPU → GPU/FPGA (2011 年) → ASIC (2013 年) と特化ハードウェアへ移行してきた．

  - CPU： 普通のパソコンに搭載

  - GPU： GPGPU で高速な並列計算が可能

  - FPGA: 回路をプログラム可能

  - ASIC：専用回路

- ハッシュレート

  - ビットコインネットワーク全体の毎秒総生成ハッシュ数

- ハードウェアの進化とマイニングノードの増加により、指数関数的に増加している

- これに伴い difficulty も増加するので、新規参入は困難
  - 手元の PC で気軽にマイニングしても難しい

## マイニングプール

- 複数人でマイニングを分担する仕組み
- 複数人のマイナーを集めて一緒にマイニングを行い、報酬を分配する
- マイナーは報酬額は減るが、日々平均的な報酬を得られるようになる

- マネージドプール

  - 管理者がいるマイニングプール
  - 管理者がプールマイニングプロトコルの管理や、フルノードのメンテナンスなどを行う．
  - 報酬は管理者が受け取って，参加者に分配する
  - 管理者は、報酬の一部を手数料として受けとる

- P2PPool

  - マネージドプールは管理者によって不正がなされる可能性もある

  - P2PPool ではシェアチェーンと呼ばれる小型ブロックチェーンのようなチェーンを用いて
    参加者はシェアチェーンを掘る - ビットコインブロックチェーンより低い Difficulty が設定される
  - そのうち、ビットコインブロックチェーンでの Difficulty を充足させるブロックが発見されたら
    それを採用する

  - 報酬の分配ルールもシェアチェーンで管理され特定の誰かが不正できなくなっている

## コンセンサス攻撃

- 特定のマイナーがハッシュレートの多くを占めていると、先端のブロック伸長をある程度操作す
  ることが可能になる

  - 2 ブロック分マイニングできるくらいのハッシュレートを持っていれば、1 ブロック分のフォー
    クは無効化できる

- 51%アタックと呼ばれる

  - 6 ブロック以上を無効化できる可能性がある
  - 特定アドレスが関与する支払いを無効化するために意図的にフォーク
  - 51%というのは必ずしもハッシュレートの 51%が必要というわけではない

- マイニングプールが不正を行おうとするとかなり問題

## まとめ

- 新しいブロック（トランザクション）が正しいといかにしてコンセンサスを得るか

  - 皆が同じルールに基づいて検証を行っている
  - もしこの検証を通らないブロックを伝搬させようとしても他の多くのノードで無効と判断され
    る
  - 最長ブロックチェーンが残っていくため、いち早く正しく長いチェーンを作ることがマイナーのインセンティブになっている

- マイニング

  - PoW の解を見つければ報酬を得られる
    -2024/01 現在 6.25BTC=約 3,700 万円（1BTC=600 万円）

  - マイニング報酬を得たいがためにすべてのノードは「正しい」振舞いをする
    - 正しくブロックを作る
    - 正しくブロックを検証する

- コンセンサスアタック
  - ハッシュレートの多くの割合を一部の人が持ってしまうとコンセンサスメカニズムを破壊で
    きる（51%攻撃）
  - マイニングプールがそれができる傾向があるが、P2PPool など管理者不在の方法も考案さ
    れている
